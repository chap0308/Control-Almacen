let paso=1;const pasoInicial=1,pasoFinal=3,solicitud={preCompras:[],proveedor1:{},fecha:"",cantidad:[],productos:[],precioCostoNuevo:[],gananciaS:[],vaciador:[]};function iniciarApp(){mostrarSeccion(),tabs(),botonesPaginador(),paginaSiguiente(),paginaAnterior(),consultarAPI(),seleccionarFecha(),mostrarResumen(),vaciar()}function mostrarSeccion(){const e=document.querySelector(".mostrar");e&&e.classList.remove("mostrar");const t="#paso-"+paso;document.querySelector(t).classList.add("mostrar");const o=document.querySelector(".actual");o&&o.classList.remove("actual");document.querySelector(`[data-paso="${paso}"]`).classList.add("actual")}function tabs(){document.querySelectorAll(".tabs button").forEach(e=>{e.addEventListener("click",(function(e){e.preventDefault(),paso=parseInt(e.target.dataset.paso),mostrarSeccion(),botonesPaginador()}))})}function botonesPaginador(){const e=document.querySelector("#anterior"),t=document.querySelector("#siguiente");1===paso?(e.classList.add("ocultar"),t.classList.remove("ocultar"),vaciar(),quitar()):3===paso?(e.classList.remove("ocultar"),t.classList.add("ocultar"),mostrarResumen()):(e.classList.remove("ocultar"),t.classList.remove("ocultar"),vaciar(),quitar()),mostrarSeccion()}function paginaAnterior(){document.querySelector("#anterior").addEventListener("click",(function(){paso<=1||(paso--,botonesPaginador())}))}function paginaSiguiente(){document.querySelector("#siguiente").addEventListener("click",(function(){paso>=3||(paso++,botonesPaginador())}))}function quitar(){const e=document.querySelector('[data-paso="3"]');e.hasAttribute("disabled")&&e.removeAttribute("disabled")}async function consultarAPI(){try{const e="/api/productos",t=await fetch(e),o=await t.json();mostrarProductosyProveedores(o.productos,o.proveedores)}catch(e){console.log(e)}}function mostrarProductosyProveedores(e=[],t=[]){e.forEach(e=>{const{id:t,descripcion:o,precio_costo:a,stock:n}=e,c={id:e.id,cant:null},i={id:e.id,cant:e.ganancia},r={id:e.id,cant:null},d={id:e.id,cant:0};let s="";s=n<=10?"red":n<=25?"yellow":"green";const l=document.createElement("P");l.classList.add("nombre-servicio"),l.textContent=o;const u=document.createElement("P");u.classList.add("precio-servicio"),u.textContent=0==a?"":"$ "+a,u.setAttribute("style","display: inline-grid;");const p=document.createElement("SPAN");p.classList.add(""+s),p.textContent="Stock: "+n,p.setAttribute("style","margin-left: 70rem;color: black;padding:0.4rem;"),u.appendChild(p);const m=document.createElement("DIV");m.classList.add("servicio"),m.dataset.idProducto=t,m.onclick=function(){seleccionarProducto(e),seleccionarCantidad(c),seleccionarGanancia(i),seleccionarPreComp(r),seleccionarCostoNuevo(d)},m.appendChild(l),m.appendChild(u),document.querySelector("#servicios").appendChild(m)}),t.forEach(e=>{const{id:t,nombre:o}=e,a=document.createElement("option");a.value=""+t,a.textContent=""+o,document.querySelector("#proveedor").appendChild(a)}),document.querySelector("#proveedor").addEventListener("change",e=>{const o=e.target.value;for(let e=0;e<t.length;e++)t[e].id==o&&(solicitud.proveedor1=t[e])})}function seleccionarProducto(e){const{id:t}=e,{productos:o}=solicitud,a=document.querySelector(`[data-id-producto="${t}"]`);o.some(e=>e.id===t)?(solicitud.productos=o.filter(e=>e.id!==t),a.classList.remove("seleccionado")):(solicitud.productos=[...o,e],a.classList.add("seleccionado"))}function seleccionarCantidad(e){const{id:t}=e,{cantidad:o}=solicitud;o.some(e=>e.id===t)?solicitud.cantidad=o.filter(e=>e.id!==t):solicitud.cantidad=[...o,e]}function seleccionarGanancia(e){const{id:t}=e,{gananciaS:o}=solicitud;o.some(e=>e.id===t)?solicitud.gananciaS=o.filter(e=>e.id!==t):solicitud.gananciaS=[...o,e]}function seleccionarPreComp(e){const{id:t}=e,{preCompras:o}=solicitud;o.some(e=>e.id===t)?solicitud.preCompras=o.filter(e=>e.id!==t):solicitud.preCompras=[...o,e]}function seleccionarCostoNuevo(e){const{id:t}=e,{precioCostoNuevo:o}=solicitud;o.some(e=>e.id===t)?solicitud.precioCostoNuevo=o.filter(e=>e.id!==t):solicitud.precioCostoNuevo=[...o,e]}function seleccionarFecha(){const e=document.querySelector("#fecha").value;solicitud.fecha=e}function mostrarAlerta(e,t,o,a=!0){const n=document.querySelector(".alerta");n&&n.remove();const c=document.createElement("DIV");c.textContent=e,c.classList.add("alerta"),c.classList.add(t);document.querySelector(o).appendChild(c),a&&setTimeout(()=>{c.remove()},3e3)}function vaciar(){solicitud.vaciador=[]}function mostrarResumen(){const e=document.querySelector(".actual");"3"===e.getAttribute("data-paso")&&e.classList.contains("actual")&&(e.disabled=!0);const t=document.querySelector(".contenido-resumen");for(;t.firstChild;)t.removeChild(t.firstChild);if(0===Object.keys(solicitud.proveedor1).length||0===solicitud.productos.length||""===solicitud.fecha)return void mostrarAlerta("Faltan datos de Productos, Fecha u Hora","error",".contenido-resumen",!1);const{proveedor1:{nombre:o,email:a},fecha:n,productos:c}=solicitud,i=document.createElement("H3");i.textContent="Resumen de Productos",t.appendChild(i),c.forEach(e=>{const{vaciador:o,cantidad:a,preCompras:n,precioCostoNuevo:c,gananciaS:i}=solicitud;o.push(null);const{descripcion:r,precio_costo:d,ganancia:s}=e;let l=s;0==l?NGan=l:(l=100*(Number(s)-1),NGan=l.toFixed(2));const u=document.createElement("DIV");u.classList.add("contenedor-servicio"),u.setAttribute("id","contenedor"+o.length);const p=document.createElement("P");p.textContent=r;const m=document.createElement("P");m.innerHTML="<span>Precio:</span> $";const v=document.createElement("input");v.setAttribute("id","precioNuevo"+o.length),v.setAttribute("step","0.01"),v.setAttribute("type","number"),v.setAttribute("value",""+d),m.appendChild(v);const g=document.createElement("P");g.innerHTML="<span>Cantidad: </span>";const C=document.createElement("input");C.setAttribute("id","cantidadProducto"+o.length),C.setAttribute("step","1"),C.setAttribute("type","number"),g.appendChild(C);const f=document.createElement("P");f.innerHTML="<span>Ganancia (%): </span>";const h=document.createElement("input");h.setAttribute("id","ganancia"+o.length),h.setAttribute("type","number"),h.setAttribute("step","0.01"),h.setAttribute("placeholder","Ejemplo:50,65.50,..."),h.setAttribute("max","500"),h.setAttribute("value",""+NGan),f.appendChild(h);const y=document.createElement("P");y.innerHTML="<span>Precio Compra: </span>";const S=document.createElement("input");S.setAttribute("id","precioCompra"+o.length),S.setAttribute("type","number"),S.setAttribute("step","0.01"),S.setAttribute("readonly",""),y.appendChild(S),u.appendChild(p),u.appendChild(m),u.appendChild(g),u.appendChild(f),u.appendChild(y),t.appendChild(u)});for(let e=0;e<solicitud.vaciador.length;e++){let{cantidad:t,productos:o,precioCostoNuevo:a,gananciaS:n,preCompras:c}=solicitud;if(null!==t[e].cant&&(document.querySelector("#cantidadProducto"+(e+1)).value=t[e].cant,document.getElementById("precioCompra"+(e+1)).value=c[e].cant),0!==a[e].cant)document.querySelector("#precioNuevo"+(e+1)).value=a[e].cant;else if(0==a[e].cant&&t[e].cant){let a=parseFloat(o[e].precio_costo)*t[e].cant;document.querySelector("#precioCompra"+(e+1)).value=a.toFixed(2),c[e].cant=document.querySelector("#precioCompra"+(e+1)).value}if(0==n[e].cant)document.querySelector("#ganancia"+(e+1)).value=0;else if(1==n[e].cant){let t=document.querySelector("#ganancia"+(e+1)).value;const o=parseFloat(t).toFixed(2)/100+1;n[e].cant=o.toFixed(4)}else if("NaN"===n[e].cant){if(0!=o[e].ganancia){let t=100*o[e].ganancia-100;return document.querySelector("#ganancia"+(e+1)).value=t.toFixed(2),void(n[e].cant=o[e].ganancia)}document.querySelector("#ganancia"+(e+1)).value=0}else if(n[e].cant){let t=100*parseFloat(n[e].cant)-100;document.querySelector("#ganancia"+(e+1)).value=t.toFixed(2)}document.querySelector("#precioNuevo"+(e+1)).addEventListener("input",c=>{const i=c.target.value,r=parseFloat(i).toFixed(2),d=document.querySelector("#cantidadProducto"+(e+1)).value,s=o[e].precio_costo;cantNum=parseInt(d),t[e].cant=cantNum;const l=document.querySelector("#ganancia"+(e+1)).value,u=parseFloat(l).toFixed(2)/100+1;if(n[e].cant=u.toFixed(4),""===d||isNaN(r)||0==r||0==d)document.getElementById("precioCompra"+(e+1)).value="",solicitud.preCompras[e].cant=null,a[e].cant=0;else if(d&&s==r){a[e].cant=0;let n=t[e].cant*o[e].precio_costo;nuevoResultado=n.toFixed(2),document.getElementById("precioCompra"+(e+1)).value=nuevoResultado;let c=document.getElementById("precioCompra"+(e+1)).value;valorNum=parseFloat(c),solicitud.preCompras[e].cant=valorNum}else if(d&&s!=r){a[e].cant=r;let o=t[e].cant*r;nuevoResultado=o.toFixed(2),document.getElementById("precioCompra"+(e+1)).value=nuevoResultado;let n=document.getElementById("precioCompra"+(e+1)).value;valorNum=parseFloat(n),solicitud.preCompras[e].cant=valorNum}}),document.querySelector("#cantidadProducto"+(e+1)).addEventListener("input",c=>{const i=document.querySelector("#precioNuevo"+(e+1)).value,r=c.target.value,d=o[e].precio_costo;cantNum=parseInt(r),t[e].cant=cantNum;const s=document.querySelector("#ganancia"+(e+1)).value,l=parseFloat(s).toFixed(2)/100+1;if(n[e].cant=l.toFixed(4),""===r||isNaN(i)||0==i||0==r)document.getElementById("precioCompra"+(e+1)).value="",solicitud.preCompras[e].cant=null;else if(r&&d==i){a[e].cant=0;let n=t[e].cant*o[e].precio_costo;nuevoResultado=n.toFixed(2),document.getElementById("precioCompra"+(e+1)).value=nuevoResultado;let c=document.getElementById("precioCompra"+(e+1)).value;valorNum=parseFloat(c),solicitud.preCompras[e].cant=valorNum}else if(r&&d!=i){a[e].cant=i;let o=t[e].cant*i;nuevoResultado=o.toFixed(2),document.getElementById("precioCompra"+(e+1)).value=nuevoResultado;let n=document.getElementById("precioCompra"+(e+1)).value;valorNum=parseFloat(n),solicitud.preCompras[e].cant=valorNum}}),document.querySelector("#ganancia"+(e+1)).addEventListener("input",t=>{const o=t.target.value,a=parseFloat(o).toFixed(2)/100+1;n[e].cant=a.toFixed(4)})}const r=document.createElement("H3");r.textContent="Resumen del Proveedor",t.appendChild(r);const d=document.createElement("P");d.innerHTML="<span>Nombre del Proveedor:</span> "+o;const s=document.createElement("P");s.innerHTML="<span>Correo del Proveedor:</span> "+a;const l=new Date(n),u=l.getMonth(),p=l.getDate()+2,m=l.getFullYear(),v=new Date(Date.UTC(m,u,p)).toLocaleDateString("es-PE",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),g=document.createElement("P");g.innerHTML="<span>Fecha:</span> "+v;const C=document.createElement("BUTTON");C.classList.add("boton"),C.textContent="Guardar Solicitud",C.onclick=validarSolicitud,t.appendChild(d),t.appendChild(s),t.appendChild(g),t.appendChild(C)}function validarSolicitud(){const{preCompras:e,cantidad:t,gananciaS:o}=solicitud,a=e.map(e=>parseFloat(e.cant)),n=t.map(e=>parseInt(e.cant)),c=o.map(e=>parseFloat(e.cant));a.includes(null)||a.includes(NaN)||n.includes(NaN)||n.includes(null)||c.includes(NaN)||c.includes(null)||c.includes(1)||c.includes("0.00")||c.includes("1.0000")?mostrarAlerta("Completa todos los datos","error",".contenido-resumen",!0):guardarSolicitud(a,n,c)}async function guardarSolicitud(e,t,o){const{fecha:a,productos:n,proveedor1:c,precioCostoNuevo:i}=solicitud,r=c.id,d=n.map(e=>e.id),s=n.map(e=>parseFloat(e.precio_costo)),l=n.map(e=>parseInt(e.stock)),u=i.map(e=>parseFloat(e.cant)),p=n.map(e=>parseFloat(e.precio_unitarioVenta));console.log(u);for(let e=0;e<u.length;e++)0==n[e].precio_costo&&(n[e].fecha_inicial=a);const m=n.map(e=>e.fecha_inicial);for(let e=0;e<u.length;e++)if(0!==u[e]){let a=(s[e]*l[e]+u[e]*t[e])/(l[e]+t[e]);n[e].precio_costo=a.toFixed(2),s[e]=u[e],p[e]=o[e]*n[e].precio_costo,n[e].precio_unitarioVenta=p[e].toFixed(2),n[e].ganancia=o[e]}else p[e]=o[e]*s[e],n[e].precio_unitarioVenta=p[e].toFixed(2),n[e].ganancia=o[e];const v=n.map(e=>e.precio_costo),g=n.map(e=>parseFloat(e.precio_unitarioVenta)),C=l.map((e,o)=>e+t[o]);let f=e.reduce((e,t)=>e+t,0);const h=new FormData;h.append("proveedor_id",r),h.append("fecha_solicitud",a),h.append("precioTotal",f),h.append("productos",d),h.append("cantidad_entrada",t),h.append("precio_unitario",s),h.append("precio_compra",e),h.append("stock",C),h.append("precio_costo",v),h.append("ganancia",o),h.append("precio_unitarioVenta",g),h.append("fecha_inicial",m);try{const e="/api/solicitudes",t=await fetch(e,{method:"POST",body:h});await t.json()&&Swal.fire({icon:"success",title:"Solicitud Registrada",text:"La solicitud fue registrada correctamente",button:"OK"}).then(()=>{window.location.reload()})}catch(e){Swal.fire({icon:"error",title:"Error",text:"Hubo un error al registrar la solicitud"})}}document.addEventListener("DOMContentLoaded",(function(){iniciarApp()}));