let paso=1;const pasoInicial=1,pasoFinal=3,pedidos={preVentas:[],clientes1:{},fecha:"",cantidad:[],productos:[],vaciador:[]};function iniciarApp(){mostrarSeccion(),tabs(),botonesPaginador(),paginaSiguiente(),paginaAnterior(),consultarAPI(),seleccionarFecha(),mostrarResumen(),vaciar()}function mostrarSeccion(){const e=document.querySelector(".mostrar");e&&e.classList.remove("mostrar");const t="#paso-"+paso;document.querySelector(t).classList.add("mostrar");const n=document.querySelector(".actual");n&&n.classList.remove("actual");document.querySelector(`[data-paso="${paso}"]`).classList.add("actual")}function tabs(){document.querySelectorAll(".tabs button").forEach(e=>{e.addEventListener("click",(function(e){e.preventDefault(),paso=parseInt(e.target.dataset.paso),mostrarSeccion(),botonesPaginador()}))})}function botonesPaginador(){const e=document.querySelector("#anterior"),t=document.querySelector("#siguiente");1===paso?(e.classList.add("ocultar"),t.classList.remove("ocultar"),vaciar(),quitar()):3===paso?(e.classList.remove("ocultar"),t.classList.add("ocultar"),mostrarResumen()):(e.classList.remove("ocultar"),t.classList.remove("ocultar"),vaciar(),quitar()),mostrarSeccion()}function paginaAnterior(){document.querySelector("#anterior").addEventListener("click",(function(){paso<=1||(paso--,botonesPaginador())}))}function paginaSiguiente(){document.querySelector("#siguiente").addEventListener("click",(function(){paso>=3||(paso++,botonesPaginador())}))}async function consultarAPI(){try{const e="/api/productos",t=await fetch(e),n=await t.json();mostrarProductos(n.productos,n.clientes)}catch(e){console.log(e)}}function mostrarProductos(e=[],t=[]){e.forEach(e=>{const{id:t,descripcion:n,precio_unitarioVenta:o,stock:a}=e,c={id:e.id,cant:null},d={id:e.id,cant:null};let i="";i=a<=10?"red":a<=25?"yellow":"green";const r=document.createElement("P");r.classList.add("nombre-servicio"),r.textContent=n;const s=document.createElement("P");s.classList.add("precio-servicio"),s.textContent=0==o||0==a?"":"$ "+o,s.setAttribute("style","display: inline-grid;");const l=document.createElement("SPAN");l.classList.add(""+i),l.textContent="Stock: "+a,l.setAttribute("style","margin-left: 70rem;color: black;padding:0.4rem;"),s.appendChild(l);const u=document.createElement("DIV");u.classList.add("servicio"),0==a&&u.classList.add("disabled"),u.dataset.idProducto=t,u.onclick=function(){seleccionarProducto(e),seleccionarCantidad(c),seleccionarPreVenta(d)},u.appendChild(r),u.appendChild(s),document.querySelector("#servicios").appendChild(u)}),t.forEach(e=>{const{id:t,nombre:n}=e,o=document.createElement("option");o.value=""+t,o.textContent=""+n,document.querySelector("#cliente").appendChild(o)}),document.querySelector("#cliente").addEventListener("change",e=>{const n=e.target.value;for(let e=0;e<t.length;e++)t[e].id==n&&(pedidos.clientes1=t[e])})}function seleccionarProducto(e){const{id:t}=e,{productos:n}=pedidos,o=document.querySelector(`[data-id-producto="${t}"]`);n.some(e=>e.id===t)?(pedidos.productos=n.filter(e=>e.id!==t),o.classList.remove("seleccionado")):(pedidos.productos=[...n,e],o.classList.add("seleccionado"))}function seleccionarCantidad(e){const{id:t}=e,{cantidad:n}=pedidos;n.some(e=>e.id===t)?pedidos.cantidad=n.filter(e=>e.id!==t):pedidos.cantidad=[...n,e]}function seleccionarPreVenta(e){const{id:t}=e,{preVentas:n}=pedidos;n.some(e=>e.id===t)?pedidos.preVentas=n.filter(e=>e.id!==t):pedidos.preVentas=[...n,e]}function seleccionarFecha(){const e=document.querySelector("#fecha").value;pedidos.fecha=e}function mostrarAlerta(e,t,n,o=!0){const a=document.querySelector(".alerta");a&&a.remove();const c=document.createElement("DIV");c.textContent=e,c.classList.add("alerta"),c.classList.add(t);document.querySelector(n).appendChild(c),o&&setTimeout(()=>{c.remove()},3e3)}function vaciar(){pedidos.vaciador=[]}function quitar(){const e=document.querySelector('[data-paso="3"]');e.hasAttribute("disabled")&&e.removeAttribute("disabled")}function mostrarResumen(){const e=document.querySelector(".actual");"3"===e.getAttribute("data-paso")&&e.classList.contains("actual")&&(e.disabled=!0);const t=document.querySelector(".contenido-resumen");for(;t.firstChild;)t.removeChild(t.firstChild);if(0===Object.keys(pedidos.clientes1).length||0===pedidos.productos.length||""===pedidos.fecha)return void mostrarAlerta("Faltan datos de Productos, Fecha u Hora","error",".contenido-resumen",!1);const{clientes1:{nombre:n,email:o},fecha:a,productos:c}=pedidos,d=document.createElement("H3");d.textContent="Resumen de Productos",t.appendChild(d);document.querySelector('[data-paso="3"]');c.forEach(e=>{const{vaciador:n,cantidad:o,preVentas:a}=pedidos;n.push(null);const{descripcion:c,precio_unitarioVenta:d}=e,i=document.createElement("DIV");i.classList.add("contenedor-servicio");const r=document.createElement("P");r.textContent=c;const s=document.createElement("P");s.innerHTML="<span>Precio:</span> $"+d;const l=document.createElement("P");l.innerHTML="<span>Cantidad: </span>";const u=document.createElement("input");u.setAttribute("id","cantidadProducto"+n.length),u.setAttribute("step","1"),u.setAttribute("type","number"),l.appendChild(u);const p=document.createElement("P");p.innerHTML="<span>Precio Venta: </span>";const m=document.createElement("input");m.setAttribute("id","precioVenta"+n.length),m.setAttribute("type","number"),m.setAttribute("step","0.01"),m.setAttribute("readonly",""),p.appendChild(m),i.appendChild(r),i.appendChild(s),i.appendChild(l),i.appendChild(p),t.appendChild(i)});for(let e=0;e<pedidos.vaciador.length;e++){let{cantidad:t,preVentas:n}=pedidos;null!==t[e].cant&&(document.querySelector("#cantidadProducto"+(e+1)).value=t[e].cant,document.getElementById("precioVenta"+(e+1)).value=n[e].cant),document.querySelector("#cantidadProducto"+(e+1)).addEventListener("input",n=>{const o=n.target.value;if(cantNum=parseInt(o),t[e].cant=cantNum,""===o)document.getElementById("precioVenta"+(e+1)).value="",pedidos.preVentas[e].cant=null;else if(o){let n=t[e].cant*c[e].precio_unitarioVenta;nuevoResultado=n.toFixed(2),document.getElementById("precioVenta"+(e+1)).value=nuevoResultado;let o=document.getElementById("precioVenta"+(e+1)).value;valorNum=parseFloat(o),pedidos.preVentas[e].cant=valorNum}})}const i=document.createElement("H3");i.textContent="Resumen del Cliente",t.appendChild(i);const r=document.createElement("P");r.innerHTML="<span>Nombre del Cliente:</span> "+n;const s=document.createElement("P");s.innerHTML="<span>Correo del Cliente:</span> "+o;const l=new Date(a),u=l.getMonth(),p=l.getDate()+2,m=l.getFullYear(),h=new Date(Date.UTC(m,u,p)).toLocaleDateString("es-PE",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),f=document.createElement("P");f.innerHTML="<span>Fecha:</span> "+h;const v=document.createElement("BUTTON");v.classList.add("boton"),v.textContent="Guardar Pedido",v.onclick=validarPedido,t.appendChild(r),t.appendChild(s),t.appendChild(f),t.appendChild(v)}function validarPedido(){document.querySelector(".contenido-resumen");const{preVentas:e,cantidad:t}=pedidos,n=e.map(e=>parseFloat(e.cant)),o=t.map(e=>parseInt(e.cant));n.includes(NaN)||n.includes(0)||o.includes(NaN)||o.includes(0)?mostrarAlerta("Completa todos los datos","error",".contenido-resumen",!0):guardarPedido(n,o)}async function guardarPedido(e,t){const{fecha:n,productos:o,clientes1:a}=pedidos,c=a.id,d=o.map(e=>e.id),i=o.map(e=>parseFloat(e.precio_unitarioVenta)),r=o.map(e=>parseInt(e.stock)).map((e,n)=>e-t[n]);let s=e.reduce((e,t)=>e+t,0);const l=new FormData;l.append("clientes_id",c),l.append("fecha_pedido",n),l.append("precioTotal",s),l.append("productos",d),l.append("cantidad_salida",t),l.append("precio_unitario",i),l.append("precio_venta",e),l.append("stock",r);try{const e="/api/pedidos",t=await fetch(e,{method:"POST",body:l});await t.json()&&Swal.fire({icon:"success",title:"Pedido Registrado",text:"El pedido fue registrado correctamente",button:"OK"}).then(()=>{window.location.reload()})}catch(e){Swal.fire({icon:"error",title:"Error",text:"Hubo un error al registrar el pedido"})}}document.addEventListener("DOMContentLoaded",(function(){iniciarApp()}));